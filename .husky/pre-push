#!/bin/sh
set -e

# Check if we are ahead/behind upstream
upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)

if [ -n "$upstream" ]; then
  counts=$(git rev-list --left-right --count HEAD...@{u})
  ahead=$(echo "$counts" | awk '{print $1}')
  behind=$(echo "$counts" | awk '{print $2}')

  if [ "$behind" -gt 0 ]; then
    echo "pre-push: Your branch is behind '$upstream' by $behind commits."
    echo "pre-push: Please pull before pushing."
    exit 1
  fi

  if [ "$ahead" -eq 0 ]; then
    echo "pre-push: Your branch is up to date with '$upstream'."
    echo "pre-push: No new commits to verify. Skipping checks."
    exit 0
  fi
fi

# Check types in case did not npm run build (which runs tsc)
npm run type-check

# Lint check
npx eslint .

# Check formatting
npx prettier --check .

# Run all unit tests to ensure no regressions (fail fast)
npm run test:unit